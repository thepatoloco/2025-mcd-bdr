# Base de datos relacionales

## Tarea 4

### Instrucciones

- Instalen un SGBD
- Instalen DBeaver
- Crea la base de datos y tablas correspondientes a su base de datos
- Incluye al menos 5 registros en tu base de datos (en total)

### Script base de datos

El siguiente código esta diseñado para postgresql.

#### Creación esquema

```postgresql
CREATE SCHEMA IF NOT EXISTS bdr_messages;
```

#### Creación tablas (Up Script)

```postgresql
CREATE TABLE IF NOT EXISTS bdr_messages.users (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(100)
);

CREATE TABLE IF NOT EXISTS bdr_messages.groups (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(100)
);

CREATE TABLE IF NOT EXISTS bdr_messages.group_user (
    group_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,

    PRIMARY KEY (group_id, user_id),

    CONSTRAINT fk_group_user_group_id
        FOREIGN KEY (group_id)
        REFERENCES bdr_messages.groups(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    
    CONSTRAINT fk_group_user_user_id
        FOREIGN KEY (user_id)
        REFERENCES bdr_messages.users(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS bdr_messages.messages (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id INTEGER,
    group_id INTEGER NOT NULL,
    content TEXT,
    image_url VARCHAR(100),
    answers_to INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW(),

    CONSTRAINT fk_messages_user_id
        FOREIGN KEY (user_id)
        REFERENCES bdr_messages.users(id)
        ON UPDATE CASCADE
        ON DELETE SET NULL,

    CONSTRAINT fk_messages_group_id
        FOREIGN KEY (group_id)
        REFERENCES bdr_messages.groups(id)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    
    CONSTRAINT fk_messages_answers_to
        FOREIGN KEY (answers_to)
        REFERENCES bdr_messages.messages(id)
        ON UPDATE CASCADE
        ON DELETE SET NULL
);
```

#### Eliminación tablas (Down Script)

```postgresql
DROP TABLE IF EXISTS bdr_messages.messages;

DROP TABLE IF EXISTS bdr_messages.group_user;

DROP TABLE IF EXISTS bdr_messages.groups;

DROP TABLE IF EXISTS bdr_messages.users;
```

### Inserción de registros (Seeder)

```postgresql
WITH inserted_group AS (
    INSERT INTO bdr_messages.groups (id, name) 
    VALUES (123, 'UANL') 
    ON CONFLICT (id) DO NOTHING
    RETURNING id
),
inserted_user AS (
    INSERT INTO bdr_messages.users (id, name) 
    VALUES (215, 'Pato') 
    ON CONFLICT (id) DO NOTHING
    RETURNING id
)
INSERT INTO bdr_messages.group_user (group_id, user_id) 
SELECT 
    inserted_group.id AS group_id, 
    inserted_user.id AS user_id
FROM inserted_group, inserted_user 
ON CONFLICT (group_id, user_id) DO NOTHING;

WITH first_message AS (
    INSERT INTO bdr_messages.messages (user_id, group_id, content, created_at)
    VALUES (215, 123, 'Hola, estoy feliz :)', '2021-01-29T07:16:46+00:00')
    RETURNING id
)
INSERT INTO bdr_messages.messages (user_id, group_id, content, answers_to)
SELECT 
    215 as user_id,
    123 as group_id,
    'Corrección, estaba feliz' as content,
    first_message.id as answers_to
FROM first_message;
```
